<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR YouTube 3D Video</title>

  <!-- A-Frame & AR.js -->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <script>
    const API_URL = "https://breath-civilization-friday-movers.trycloudflare.com"; // Your backend

    function getToken() {
      const token = localStorage.getItem("arToken");
      if (!token) alert("You must login first to access AR content!");
      return token;
    }

    async function unlockNextSection() {
      const token = getToken();
      if (!token) return;

      try {
        // Ask backend which section to unlock next
        const res = await fetch(`${API_URL}/unlocked-sections`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        const unlocked = data.unlocked_sections || [];
        
        // Define all sections in order
        const sections = ["section1","section2","section3"];
        const nextSection = sections.find(sec => !unlocked.includes(sec));
        if (!nextSection) return;

        // Unlock next section
        const unlockRes = await fetch(`${API_URL}/unlock-section`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ section_id: nextSection })
        });
        const unlockData = await unlockRes.json();
        console.log("Unlocked:", unlockData.unlocked_sections);
      } catch(err) {
        console.error("Failed to unlock next section:", err);
      }
    }

    // Minimal YouTube component for AR
    AFRAME.registerComponent('youtube-plane', {
      schema: { videoId: { type: 'string' } },
      init: function () {
        const marker = this.el;

        // Hidden video element
        this.videoEl = document.createElement('video');
        this.videoEl.setAttribute('playsinline', '');
        this.videoEl.style.display = 'none';
        document.body.appendChild(this.videoEl);

        // YT Player API
        this.player = new YT.Player(this.videoEl, {
          videoId: this.data.videoId,
          events: { 'onReady': () => console.log("YT Player ready") }
        });

        // Marker events
        marker.addEventListener('markerFound', () => {
          this.videoEl.style.display = 'block';
          this.videoEl.play();
          unlockNextSection(); // Unlock next image on main website
        });

        marker.addEventListener('markerLost', () => {
          this.videoEl.pause();
          this.videoEl.style.display = 'none';
        });
      }
    });
  </script>
</head>

<body>
  <a-scene
    vr-mode-ui="enabled: false"
    arjs='sourceType: webcam; debugUIEnabled: false;'
    embedded
  >
    <!-- Single Marker -->
    <a-marker
      type="pattern"
      preset="custom"
      url="assets/marker1.patt"
      youtube-plane="videoId: VIDEO_ID"
    >
      <a-plane
        position="0 0.1 0"
        rotation="-90 0 0"
        width="1.5"
        height="0.85"
        material="shader: flat; src: #youtubeVideoTexture"
      ></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script src="https://youtu.be/ZQ8qg5Xi018"></script>
</body>
</html>
