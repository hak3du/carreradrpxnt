<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>AHE Interactive AR Scene</title>

    <!-- Core Libraries -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
      }
      #instructions {
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        font-family: monospace;
        border-radius: 8px;
        z-index: 9999;
      }
    </style>

    <script>
      const API_URL = "https://breath-civilization-friday-movers.trycloudflare.com";

      function getToken() {
        const token = localStorage.getItem("arToken");
        if (!token) alert("You must login first to access AR content!");
        return token;
      }

      async function unlockNextSection() {
        const token = getToken();
        if (!token) return;

        try {
          const res = await fetch(`${API_URL}/unlocked-sections`, {
            headers: { "Authorization": `Bearer ${token}` }
          });
          const data = await res.json();
          const unlocked = data.unlocked_sections || [];

          const sections = ["section1", "section2", "section3"];
          const nextSection = sections.find(sec => !unlocked.includes(sec));
          if (!nextSection) return;

          const unlockRes = await fetch(`${API_URL}/unlock-section`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ section_id: nextSection })
          });

          const unlockData = await unlockRes.json();
          console.log("Unlocked:", unlockData.unlocked_sections);
        } catch (err) {
          console.error("Unlock failed:", err);
        }
      }

      // Add interactive gestures (drag/rotate/scale)
      AFRAME.registerComponent("gesture-controls", {
        init: function () {
          const el = this.el;
          let startX, startY, startRotation, startScale;

          el.sceneEl.canvas.addEventListener("mousedown", e => {
            startX = e.clientX;
            startY = e.clientY;
            startRotation = el.getAttribute("rotation");
            startScale = el.getAttribute("scale");
            this.dragging = true;
          });

          el.sceneEl.canvas.addEventListener("mousemove", e => {
            if (!this.dragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            // Rotate on X and Y
            el.setAttribute("rotation", {
              x: startRotation.x - dy * 0.1,
              y: startRotation.y + dx * 0.1,
              z: startRotation.z
            });
          });

          el.sceneEl.canvas.addEventListener("mouseup", () => {
            this.dragging = false;
          });

          // Scroll wheel for scaling
          el.sceneEl.canvas.addEventListener("wheel", e => {
            const scale = el.getAttribute("scale");
            const factor = e.deltaY < 0 ? 1.1 : 0.9;
            el.setAttribute("scale", {
              x: scale.x * factor,
              y: scale.y * factor,
              z: scale.z * factor
            });
          });
        }
      });
    </script>
  </head>

  <body>
    <div id="instructions">üé• Scan the marker to reveal the 3D video object. Drag to rotate. Scroll to zoom.</div>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
    >
      <!-- Custom Marker -->
      <a-marker type="pattern" url="marker.patt" id="videoMarker">
        <!-- Video Surface -->
      <a-entity
  id="ytPlane"
  geometry="primitive: plane; width: 2; height: 1;"
  material="shader: html; target: #ytFrame;"
  position="0 0 0"
  rotation="-90 0 0"
  gesture-controls
></a-entity>

<iframe id="ytFrame" src="https://www.youtube.com/embed/ZQ8qg5Xi018?autoplay=1&mute=1" width="640" height="360"></iframe>

      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const marker = document.querySelector("#videoMarker");
      const videoScreen = document.querySelector("#videoScreen");

      marker.addEventListener("markerFound", () => {
        console.log("Marker detected üéØ");
        unlockNextSection();
      });

      marker.addEventListener("markerLost", () => {
        console.log("Marker lost ‚ùå");
      });
    </script>
  </body>
</html>
