<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR YouTube 3D Video</title>

  <!-- A-Frame & AR.s -->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <script>
    const API_URL = "https://breath-civilization-friday-movers.trycloudflare.com"; // Your backend

    function getToken() {
      const token = localStorage.getItem("arToken");
      if (!token) alert("You must login first to access AR content!");
      return token;
    }

    async function unlockNextSection() {
      const token = getToken();
      if (!token) return;

      try {
        // Ask backend which section to unlock next
        const res = await fetch(`${API_URL}/unlocked-sections`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        const unlocked = data.unlocked_sections || [];
        
        // Define all sections in order
        const sections = ["section1","section2","section3"];
        const nextSection = sections.find(sec => !unlocked.includes(sec));
        if (!nextSection) return;

        // Unlock next section
        const unlockRes = await fetch(`${API_URL}/unlock-section`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ section_id: nextSection })
        });
        const unlockData = await unlockRes.json();
        console.log("Unlocked:", unlockData.unlocked_sections);
      } catch(err) {
        console.error("Failed to unlock next section:", err);
      }
    }

    // Minimal YouTube component for AR
    AFRAME.registerComponent('youtube-plane', {
      schema: { videoId: { type: 'string' } },
      init: function () {
        const marker = this.el;

        // Hidden video element
        this.videoEl = document.createElement('video');
        this.videoEl.setAttribute('playsinline', '');
        this.videoEl.style.display = 'none';
        document.body.appendChild(this.videoEl);

        // YT Player API
        this.player = new YT.Player(this.videoEl, {
          videoId: this.data.videoId,
          events: { 'onReady': () => console.log("YT Player ready") }
        });

        // Marker events
        marker.addEventListener('markerFound', () => {
          this.videoEl.style.display = 'block';
          this.videoEl.play();
          unlockNextSection(); // Unlock next image on main website
        });

        marker.addEventListener('markerLost', () => {
          this.videoEl.pause();
          this.videoEl.style.display = 'none';
        });
      }
    });
  </script>
</head>

<body>
  <a-scene
  vr-mode-ui="enabled: false"
  arjs='sourceType: webcam; debugUIEnabled: false;'
  embedded
>
<a-marker type="pattern" url="marker.patt">
  <a-video
    src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/textures/sintel.mp4"
    position="0 0.1 0"
    rotation="-90 0 0"
    width="1.5"
    height="0.85"
    autoplay="true"
    loop="true"
  ></a-video>
</a-marker>


  <a-entity camera></a-entity>
</a-scene>
<style>
  iframe {
    cursor: grab;
    z-index: 9999;
  }
</style>

<script>
  const iframe = document.createElement('iframe');
  iframe.width = "480";
  iframe.height = "270";
  iframe.src = "https://www.youtube.com/embed/ZQ8qg5Xi018?autoplay=1&mute=1";
  iframe.style.position = "absolute";
  iframe.style.top = "50%";
  iframe.style.left = "50%";
  iframe.style.transform = "translate(-50%, -50%)";
  iframe.style.display = "none";
  iframe.style.borderRadius = "12px";
  iframe.style.boxShadow = "0 0 20px rgba(0,0,0,0.5)";
  iframe.style.transition = "all 0.3s ease";
  document.body.appendChild(iframe);

  // drag logic
  let isDragging = false, startX, startY, initialX, initialY;

  iframe.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    const rect = iframe.getBoundingClientRect();
    initialX = rect.left;
    initialY = rect.top;
    iframe.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    iframe.style.left = `${initialX + dx}px`;
    iframe.style.top = `${initialY + dy}px`;
    iframe.style.transform = 'translate(0, 0)'; // stop center lock
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    iframe.style.cursor = 'grab';
  });

  const marker = document.querySelector("#ytMarker");
  marker.addEventListener("markerFound", () => { iframe.style.display = "block"; });
  marker.addEventListener("markerLost", () => { iframe.style.display = "none"; });
</script>

<script src="https://www.youtube.com/iframe_api"></script>

</body>
</html>
